import XcodeProj

extension Generator {
    /// Creates an `XCUserData`.
    static func createXCUserData(
        userName: String,
        customSchemes: [XCScheme],
        autogeneratedSchemes: [AutogeneratedScheme]
    ) -> XCUserData {
        let sortedAutogeneratedSchemes = autogeneratedSchemes
            .sorted { lhs, rhs in
                // xor, compare productType then alphabetical if
                // both scheme have the same productType
                guard
                    lhs.productTypeSortOrder == rhs.productTypeSortOrder
                else {
                    return lhs.productTypeSortOrder < rhs.productTypeSortOrder
                }
                
                return lhs.scheme.name < rhs.scheme.name
            }
            .map(\.scheme)

        let schemeUserStates = (customSchemes + sortedAutogeneratedSchemes)
            .enumerated()
            .map { index, scheme in
                return XCSchemeManagement.UserStateScheme(
                    name: "\(scheme.name).xcscheme",
                    shared: true,
                    orderHint: index,
                    isShown: true
                )
            }
        
        return XCUserData(
            userName: userName,
            schemes: [],
            // Create a symbolic breakpoint to bypass BUILD-4252
            breakpoints: XCBreakpointList(
                breakpoints: [XCBreakpointList.BreakpointProxy(
                    breakpointExtensionID: XCBreakpointList.BreakpointProxy.BreakpointExtensionID.symbolic,
                    breakpointContent: XCBreakpointList.BreakpointProxy.BreakpointContent(
                        continueAfterRunningActions: true,
                        symbol: "Bypass BUILD-4252"
                    )
                )]
            ),
            schemeManagement: XCSchemeManagement(
                schemeUserState: schemeUserStates
            )
        )
    }
}
